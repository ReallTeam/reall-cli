/**
 * Reall Project Coommand Line Interface
 *
 * @type {exports}
 */

var os = require("os"),
    fs = require("fs"),
    path = require("path"),
    mkdirp = require('mkdirp'),
    exec = require('child_process').exec
    pretty = require('pretty-message')
    ;

function runC(cmd, onStdOut, onStdErr, callback) {
    var child = exec(cmd, function (error, stdout, stderr) {

        callback(error, stdout, stderr);
    });

    child.stdout.on("data", function(data) {
        onStdOut(data);
    });

    child.stderr.on("data", function(data) {
        onStdErr(data);
    });
};


function runCmd(command, message, verbose, callback) {

    pretty.doing(message);
    process.stdout.write("  ");

    // Execute command..
    runC(command
        , function(data) {  // <<-- onStdOut calllback
            verbose ? console.log(data.toString()) : process.stdout.write(".");
        }
        , function(data) {  // <<-- onStdErr calllback
            verbose ? console.log(data.toString()) : process.stdout.write(".");
        }
        , function(error, stdout, stderr) {  // <<-- final calllback
            callback(error, stdout, stderr);
        }
    );
}

function mapReduce(message, mapper, reducer, combiner, transporter, input, out, verbose, callback) {

    out = out + "/" + (new Date()).getTime();

    var reallPath = '/usr/lib/node_modules/reall';
    // var reallPath = process.cwd();

    var command = path.join(/*reallPath*/ __dirname, "bin/stream.sh"), //'./bin/stream.sh',
	params = mapper + " " + reducer + " " + input + " " + out
	;

    pretty.doing('Preparing to run Hadoop MapReduce');
    pretty.inform('mapper: \t%s', mapper);
    pretty.inform('reducer: \t%s', reducer);
    if(combiner)
        pretty.inform('combiner: \t%s', combiner);
    if(transporter)
        pretty.inform('transporter: \t%s', transporter);
    pretty.inform('input: \t%s', input);
    pretty.inform('out: \t\t%s', out);
    pretty.inform();

    runCmd(command + " " + params, message, verbose, callback);
}

module.exports.run = runC;
module.exports.runCmd = runCmd;
module.exports.hadoop = {
    'mapReduce' : mapReduce,
    'mapCombine' : mapReduce,
    'mapDisplay' : mapReduce
};
